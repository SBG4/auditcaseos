# AuditCaseOS Caddy Production Configuration
# Feature 4.17: SSL/TLS with Let's Encrypt
#
# Usage:
#   1. Set DOMAIN=yourdomain.com in .env
#   2. Set TLS_MODE= (empty for Let's Encrypt)
#   3. Set ACME_EMAIL=admin@yourdomain.com
#   4. Copy this to Caddyfile: cp Caddyfile.prod Caddyfile
#   5. Ensure DNS points to your server
#   6. docker compose up -d caddy

{
    # Email for Let's Encrypt notifications
    email {$ACME_EMAIL:admin@example.com}

    # Disable admin API
    admin off
}

# Main site
{$DOMAIN} {
    # Let's Encrypt automatic (no tls directive needed)

    # Enable compression
    encode gzip zstd

    # API routes
    handle /api/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket support
    handle /api/v1/ws/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Prometheus metrics - restrict to internal
    @internal {
        remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
    }
    handle /metrics {
        @notInternal not remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
        respond @notInternal "Forbidden" 403
        reverse_proxy api:8000
    }

    # Frontend
    handle {
        reverse_proxy frontend:80 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Production security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' wss://{$DOMAIN};"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    # Logging
    log {
        output stdout
        format json
        level WARN
    }
}

# HTTP to HTTPS redirect
http://{$DOMAIN} {
    redir https://{host}{uri} permanent
}
