;; PgBouncer configuration for AuditCaseOS
;; Connection pooler for PostgreSQL - API only (Paperless/Nextcloud use direct connections)

[databases]
;; Only auditcaseos database is pooled (API uses this)
;; Paperless and Nextcloud connect directly to PostgreSQL
auditcaseos = host=postgres port=5432 dbname=auditcaseos

[pgbouncer]
;; Network settings
listen_addr = 0.0.0.0
listen_port = 5432
unix_socket_dir = /tmp

;; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Pool mode: transaction is best for async apps (SQLAlchemy + asyncpg)
;; - session: connection assigned for entire client session (least efficient)
;; - transaction: connection assigned per transaction (most efficient for async)
;; - statement: connection assigned per statement (not compatible with SQLAlchemy)
pool_mode = transaction

;; Pool sizing
;; default_pool_size: connections per user/database pair
;; min_pool_size: minimum connections to maintain
;; max_client_conn: maximum client connections PgBouncer accepts
;; max_db_connections: maximum connections to PostgreSQL per database
default_pool_size = 20
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3
max_client_conn = 500
max_db_connections = 50

;; Timeouts
server_idle_timeout = 600
server_lifetime = 3600
server_connect_timeout = 15
client_idle_timeout = 0
client_login_timeout = 60
query_timeout = 0
query_wait_timeout = 120

;; Session cleanup - DISCARD ALL resets session state between transactions
server_reset_query = DISCARD ALL
server_reset_query_always = 0

;; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

;; Admin console
admin_users = auditcaseos
stats_users = auditcaseos

;; TLS (disabled for internal Docker network)
server_tls_sslmode = disable
client_tls_sslmode = disable
